/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
Command: npx gltfjsx@6.2.16 rabbit-hole-area.glb 
*/

import React, { useRef } from 'react'
import { useGLTF, useMatcapTexture, useTexture, shaderMaterial, Float, Text } from '@react-three/drei'
import { RigidBody } from '@react-three/rapier'
import * as THREE from 'three'
import { useLoader, extend, useFrame } from '@react-three/fiber'
import portalVertexShader from 'src/shaders/portal/vertex.glsl' // TODO not a big fan of paths like this
import portalFragmentShader from 'src/shaders/portal/fragment.glsl'
import MatcapManager from 'src/MatcapManager.js'
import GenericArea from 'src/components/areas/GenericArea.jsx'

const PortalMaterial = shaderMaterial(
    {
        uTime: 0,
        uColorStart: new THREE.Color('#F2E3C6'), // Copilot came up with the inner color!
        uColorEnd: new THREE.Color('#BFA26B')
    },
    portalVertexShader,
    portalFragmentShader
)

extend({ PortalMaterial })

export default function RabbitHoleArea(props) {

    const { nodes, materials } = useGLTF('./models/rabbit-hole-area.glb')
    const matcapManager = new MatcapManager()

    const exclusions = [nodes.rabbit_hole_portal]

    // Animate portal
    const portalMaterialRef = useRef()
    useFrame((state, delta) => {
        portalMaterialRef.current.uTime += delta
    })

    return <>
        <group {...props} dispose={null}>
            <GenericArea nodes={nodes} exclusions={exclusions} />

            {/* The portal is in the exclusions so it shouldn't be added by the generic area.
                Add it here so we can contol the shader material
            */}
            <mesh key={nodes.rabbit_hole_portal.uuid}
                  geometry={nodes.rabbit_hole_portal.geometry}
                  position={[nodes.rabbit_hole_portal.position.x, nodes.rabbit_hole_portal.position.y, nodes.rabbit_hole_portal.position.z]} 
                  rotation={[nodes.rabbit_hole_portal.rotation._x, nodes.rabbit_hole_portal.rotation._y, nodes.rabbit_hole_portal.rotation._z]} 
                  scale={[nodes.rabbit_hole_portal.scale.x, nodes.rabbit_hole_portal.scale.y, nodes.rabbit_hole_portal.scale.z]}>

                    <portalMaterial ref={portalMaterialRef} />

            </mesh>

            {/* 
                TODO remove in final release
                Indicates to Beta users that the rabbit hole feature is not currently available
            */}
            <Float floatIntensity={ 0.25 } rotationIntensity={ 0.25 }>
                <Text
                    font="./fonts/bebas-neue-v9-latin-regular.woff"
                    scale={ 0.5 }
                    maxWidth={ 5 }
                    lineHeight={ 0.75 }
                    textAlign="center"
                    position={ [-13, 1, -0.5] }
                    rotation-y={ Math.PI/2 }
                    >
                    Beta Users! This feature is not available yet.
                    <meshBasicMaterial toneMapped={ false } />
                </Text>
            </Float>
               
        </group>
    </>
}

useGLTF.preload('./models/rabbit-hole-area.glb')
